# Quota Error Diagnosis & Solutions

## ğŸ” What's Happening

You're seeing this error:
```
ResourceExhausted: 429 You exceeded your current quota
Quota exceeded for metric: generativelanguage.googleapis.com/generate_content_free_tier_requests, limit: 0
```

### Root Causes:

1. **Quota Exhausted**: Your Gemini API free tier quota has been completely used up
   - Free tier requests: 0 remaining
   - Free tier input tokens: 0 remaining

2. **Background Retries**: LangChain's built-in retry mechanism continues retrying failed requests
   - The retry loop runs in the background even after the UI request "completes"
   - Each retry attempt also counts against your quota

3. **LLM Initialization May Trigger Validation**: When `ChatGoogleGenerativeAI` is instantiated, it may make a test call to validate the API key

## âœ… Immediate Solutions

### Option 1: Use Stub Mode (No Gemini Calls)

**In the Streamlit UI:**
- Check the âœ… **"Use stub (no Gemini)"** checkbox in the sidebar
- This will generate emails using local templates without any API calls

**Via Environment Variable:**
```powershell
$env:DONOTUSEGEMINI="true"
.\venv\Scripts\streamlit.exe run src\ui\streamlit_app.py
```

**Via Command Line Flag:**
```powershell
.\venv\Scripts\streamlit.exe run src\ui\streamlit_app.py -- -donotusegemini
```

### Option 2: Wait for Quota Reset

The Gemini API free tier quota resets:
- **Per minute quota**: Resets every 60 seconds
- **Daily quota**: Resets at midnight (UTC)

**Current retry delay**: 34 seconds (as shown in your error)

### Option 3: Upgrade API Key

If you need immediate access:
1. Go to https://ai.google.dev/gemini-api/docs/quota
2. Consider upgrading to a paid plan
3. Update your `.env` file with the new API key

### Option 4: Stop Background Retries

**Restart Streamlit** to kill any background retry loops:
```powershell
# Press Ctrl+C in the terminal running Streamlit, then restart:
.\venv\Scripts\streamlit.exe run src\ui\streamlit_app.py
```

## ğŸ›¡ï¸ Prevention

### What We've Already Fixed:

1. âœ… **Early stub detection**: `execute_workflow()` now checks `use_stub` BEFORE creating the LLM
2. âœ… **Quota fallback**: When quota errors are detected, the workflow automatically falls back to stub mode
3. âœ… **UI indicators**: The app shows whether an email was generated by LLM or stub

### Additional Protections:

The code now:
- Detects quota/429 errors and immediately switches to stub mode
- Shows clear messaging in the UI when stub mode is used
- Tracks the source (llm vs stub) in metadata
- Provides manual "Use stub" checkbox for proactive opt-out

## ğŸ“Š Checking Your Quota Usage

Visit: https://ai.dev/usage?tab=rate-limit

This shows:
- Current quota consumption
- Rate limits
- When quotas reset

## ğŸ”§ Technical Details

### Why You're Seeing Retries When Not Generating:

1. **LangChain's Auto-Retry**: The library has built-in retry logic with exponential backoff
2. **Long Retry Delays**: Server-suggested retry delays can be 30+ seconds
3. **Background Execution**: Retries continue in the background worker thread

### The Retry Log Format:

```
Retrying langchain_google_genai.chat_models._chat_with_retry.<locals>._chat_with_retry 
in 2.0 seconds as it raised ResourceExhausted: 429
```

This means:
- LangChain detected the error
- It's waiting 2 seconds before retry #1
- Then it will wait longer (exponential backoff) for subsequent retries
- The server suggested waiting 34 seconds total

## ğŸ¯ Recommended Action Plan

**Right Now:**
1. âœ… Check "Use stub (no Gemini)" in the Streamlit sidebar
2. ğŸ”„ Restart Streamlit to stop background retries
3. âœï¸ Test the stub mode - it should work without any Gemini calls

**For Future Use:**
1. ğŸ“Š Monitor your quota usage at https://ai.dev/usage
2. âš™ï¸ Use stub mode for testing/development
3. ğŸ’° Consider upgrading if you need higher limits
4. ğŸ• Be aware of rate limits (requests per minute)

**Testing Without Quota:**
```powershell
# Set environment variable to force stub mode
$env:DONOTUSEGEMINI="true"

# Run Streamlit
.\venv\Scripts\streamlit.exe run src\ui\streamlit_app.py

# In the UI, you should see stub-generated emails without any Gemini calls
```

## â“ FAQ

**Q: I checked "Use stub" but still see errors?**
A: The errors might be from previous requests still retrying. Restart Streamlit to clear them.

**Q: How long until my quota resets?**
A: Per-minute quotas reset every 60 seconds. Daily quotas reset at midnight UTC.

**Q: Can I increase the free tier quota?**
A: No, but you can upgrade to a paid plan for higher limits.

**Q: Why does just opening the app trigger requests?**
A: We've fixed this! The LLM is no longer created in stub mode. If you still see it, restart Streamlit.

**Q: How do I know if stub mode is working?**
A: The UI will show "âš ï¸ Offline stub used for generation" and metadata will show `source: stub`.

